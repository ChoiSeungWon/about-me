(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{346:function(t,s,a){t.exports=a.p+"assets/img/nginx1.9586c327.png"},347:function(t,s,a){t.exports=a.p+"assets/img/nginx2.7fbf3775.png"},348:function(t,s,a){t.exports=a.p+"assets/img/nginx3.86197097.png"},349:function(t,s,a){t.exports=a.p+"assets/img/nginx4.fb56ab0f.png"},350:function(t,s,a){t.exports=a.p+"assets/img/nginx5.e9ad2c47.png"},351:function(t,s,a){t.exports=a.p+"assets/img/nginx6.12e5c11c.png"},352:function(t,s,a){t.exports=a.p+"assets/img/nginx7.ea3e5f7f.png"},353:function(t,s,a){t.exports=a.p+"assets/img/nginx8.88443778.png"},354:function(t,s,a){t.exports=a.p+"assets/img/nginx9.8ad91276.png"},380:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"nginx-무중단-배포"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-무중단-배포","aria-hidden":"true"}},[t._v("#")]),t._v(" NGINX 무중단 배포")]),t._v(" "),n("p",[t._v("무중단 배포 방식에는 몇 가지가 있습니다.")]),t._v(" "),n("ul",[n("li",[t._v("AWS에서 블루 그린(Blue-Green) 무중단 배포")]),t._v(" "),n("li",[t._v("도커를 이용한 웹서비스 무중단 배포")])]),t._v(" "),n("p",[t._v("우리가 진행할 방법은 엔진엑스(Nginx)를 이용한 무중단 배포 입니다.")]),t._v(" "),n("h2",{attrs:{id:"nginx의-개요"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx의-개요","aria-hidden":"true"}},[t._v("#")]),t._v(" Nginx의 개요")]),t._v(" "),n("p",[n("img",{attrs:{src:a(346),width:"50%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")]),t._v(" "),n("p",[t._v("엔진엑스는 lgor Sysoev라는 러시아 개발자 "),n("strong",[t._v("동시접속 처리에 특화된")]),t._v(" 웹 서버 프로그램이다. "),n("strong",[t._v("Apache")]),t._v("보다 동작이 단순하고, 전달자 역할만 하기 때문에 동시 접속 처리에 특화되어 있다.")]),t._v(" "),n("h3",{attrs:{id:"_1-nginx-웹서버-의-역할"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-nginx-웹서버-의-역할","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. Nginx(웹서버)의 역할")]),t._v(" "),n("ol",[n("li",[t._v("정적 파일을 처리하는 HTTP 서버로서의 역할\n"),n("ul",[n("li",[t._v("웹서버의 역할 HTML, CSS, Javascript, 이미지와 같은 정보를 웹 브라우저에 전송하는 역할(HTTP 프로토콜을 준수)")])])]),t._v(" "),n("li",[t._v("응용프로그램 서버에 요청을 보내는 리버스 프록시로서의 역할\n"),n("ul",[n("li",[t._v("클라이언트는 서버에 요청하면, 프록시 서버가 배후 서버(reverse sever)로부터 데이터를 가져오는 역할")]),t._v(" "),n("li",[t._v("프록시 서버가 "),n("strong",[t._v("Nginx")]),t._v(", 리버스 서버가 "),n("strong",[t._v("응용프로그램 서버")])]),t._v(" "),n("li",[t._v("여러대의 응용프로그램 서버에 "),n("strong",[t._v("배분")]),t._v(" 하는 역할을 한다.")])])]),t._v(" "),n("li",[t._v("비동기 Event-Drive 기반 구조")])]),t._v(" "),n("h2",{attrs:{id:"엔진엑스-무중단-배포-구성"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#엔진엑스-무중단-배포-구성","aria-hidden":"true"}},[t._v("#")]),t._v(" 엔진엑스 무중단 배포 구성")]),t._v(" "),n("p",[t._v("엔진엑스 1대와 "),n("strong",[t._v("스프링 부트 Jar")]),t._v("를 2대 사용")]),t._v(" "),n("ul",[n("li",[t._v("엔진엑스는 80(http), 443(https) 포트를 할당")]),t._v(" "),n("li",[t._v("스프링 부트1은 8081포트 실행")]),t._v(" "),n("li",[t._v("스프링 부트2은 8082포트 실행")])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("무중단 배포 전체 구조")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(347),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")])]),t._v(" "),n("h3",{attrs:{id:"_1-엔진엑스-설치와-스프링-부트-연동"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-엔진엑스-설치와-스프링-부트-연동","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 엔진엑스 설치와 스프링 부트 연동")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("EC2 엔진엑스 설치")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo yum install nginx\n")])])]),n("p",[n("code",[t._v("엔진엑스 실행")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo service nginx start\n")])])])]),t._v(" "),n("h4",{attrs:{id:"보안-그룹-추가"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#보안-그룹-추가","aria-hidden":"true"}},[t._v("#")]),t._v(" 보안 그룹 추가")]),t._v(" "),n("p",[t._v("엔진엑스의 포트번호는 기본적으로 80입니다. EC2 인바운드 보안그룹 추가 설정을 합니다.")]),t._v(" "),n("p",[n("img",{attrs:{src:a(348),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("80번 포트로 접속")]),t._v(" "),n("img",{attrs:{src:a(349),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")])]),t._v(" "),n("h4",{attrs:{id:"엔진엑스와-스프링-부트-연동"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#엔진엑스와-스프링-부트-연동","aria-hidden":"true"}},[t._v("#")]),t._v(" 엔진엑스와 스프링 부트 연동")]),t._v(" "),n("p",[t._v("엔진엑스가 현재 실행 중인 스프링 부트 프로젝트를 바라 볼 수 있도록 프록시 설정을 하겠스빈다.")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("엔진엑스 설정 파일")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo vim /etc/nginx/nginx.conf\n")])])]),n("p",[n("code",[t._v("엔진엑스 설정 추가")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(350),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("proxy_pass http://localhost:8080;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header Host $http_host;\n")])])])]),t._v(" "),n("h4",{attrs:{id:"코드-설명"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드-설명","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드 설명")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v("proxy_pass")]),t._v(" "),n("ul",[n("li",[t._v("엔진엑스로 요청이 오면 http://localhost:8080로 전달")])])]),t._v(" "),n("li",[n("strong",[t._v("proxy_set_header XXX")]),t._v(" "),n("ul",[n("li",[t._v("실제 요청 데이터를 header의 각 항목에 할당합니다.")]),t._v(" "),n("li",[t._v("proxy_set_header X-Real-IP $remote_addr 요청자의 ip를 저장합니다.")])])])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("엔진엑스 재시작")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo service nginx restart\n")])])]),n("p",[n("code",[t._v("스프링 부트 연동완료")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(351),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")])]),t._v(" "),n("h3",{attrs:{id:"_2-무중단-배포-스크립트-만들기"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-무중단-배포-스크립트-만들기","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 무중단 배포 스크립트 만들기")]),t._v(" "),n("p",[t._v("무중단 배포 스크립트 작업 전 API를 하나 추가하겠습니다. 이 API는 이후 배포 시에 8081을 쓸지, 8082를 쓸지 판단하는 기준이 됩니다.")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("profile API 추가")])]),t._v(" "),n("div",{staticClass:"language-JAVA extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("swchoi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("webservice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springboot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" lombok"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RequiredArgsConstructor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bind"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("GetMapping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bind"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RestController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Arrays")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("java"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("util")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequiredArgsConstructor")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RestController")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Environment")]),t._v(" env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/profile"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("profile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" profiles "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Arrays")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("asList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getActiveProfiles")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" realProfiles "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Arrays")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("asList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"real"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"real1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"real2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" defaultProfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" profiles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEmpty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" profiles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" profiles"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("stream")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n               "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("filter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("realProfiles"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("contains")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n               "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("findAny")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n               "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("orElse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("defaultProfile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),n("h4",{attrs:{id:"코드설명"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드설명","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드설명")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v("env.getActiveProfiles()")]),t._v(" "),n("ul",[n("li",[t._v("현재 실행 중인 ActiveProfile을 모두 가져옵니다.")]),t._v(" "),n("li",[t._v("즉, real, oauth,real-db등이 활성화되어 있다면(active) 3개가 모두 담겨 있습니다.")])])])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("ProfileControllerTest 코드 작성")])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("swchoi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("webservice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springboot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("junit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("assertj"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Assertions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("assertThat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileControllerTest")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" real_profile이_조회된다"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//given")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" expectedProfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"real"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),t._v(" env "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addActiveProfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedProfile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addActiveProfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"oauth"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addActiveProfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"real-db"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//when")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" profile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("profile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//then")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assertThat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("profile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEqualTo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedProfile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" real_profile이_없으면_첫번째가_조회된다"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//given")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" expectedProfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"oauth"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),t._v(" env "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addActiveProfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedProfile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addActiveProfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"real-db"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//when")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" profile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("profile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//then")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assertThat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("profile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEqualTo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedProfile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" active_profile이_없으면_default가_조회된다"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//given")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" expectedProfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),t._v(" env "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileController")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//when")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" profile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("profile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//then")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assertThat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("profile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEqualTo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedProfile"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("strong",[t._v("SecurityConfig 클래스 추가")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('.antMatchers("/", "/css/**", "/images/**",\n                           "/js/**", "/h2-console/**", "/profile").permitAll()\n')])])]),n("p",[n("strong",[t._v("SecurityConfig 변경 확인 테스트 추가")])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("swchoi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("webservice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springboot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("junit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("junit"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("runner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RunWith")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beans"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Autowired")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringBootTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestRestTemplate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("server")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LocalServerPort")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpStatus")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ResponseEntity")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("junit4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringRunner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("assertj"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Assertions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("assertThat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("servlet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MockMvcResultMatchers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RunWith")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringRunner")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@SpringBootTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("webEnvironment "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringBootTest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RANDOM_PORT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProfileControllerTest")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@LocalServerPort")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestRestTemplate")]),t._v(" restTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n   "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" profile은_인증없이_호출된다"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" expected "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ResponseEntity")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" response "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" restTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getForEntity")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/profile"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assertThat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getStatusCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEqualTo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HttpStatus")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("OK"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n       "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("assertThat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBody")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEqualTo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expected"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("code",[t._v("git push 배포 확인")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(352),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br")])]),t._v(" "),n("h3",{attrs:{id:"_3-real1-real2-profile-생성"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-real1-real2-profile-생성","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. real1, real2 profile 생성")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("application-real1.properties")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("server.port=8081\nspring.profiles.include=oauth,real-db\nspring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialect\nspring.session.store-type=jdbc\n")])])]),n("p",[n("code",[t._v("application-real2.properties")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("server.port=8082\nspring.profiles.include=oauth,real-db\nspring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialect\nspring.session.store-type=jdbc\n")])])])]),t._v(" "),n("h3",{attrs:{id:"_4-엔진엑스-설정-수정"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-엔진엑스-설정-수정","aria-hidden":"true"}},[t._v("#")]),t._v(" 4. 엔진엑스 설정 수정")]),t._v(" "),n("p",[t._v("무중단 배포의 핵심은 "),n("strong",[t._v("엔진엑스 설정")]),t._v("입니다. 배포 때마다 엔진엑스의 프록시 설정(스프링 부트로 요청을 흘려 보내는)이 순식간에 교체됩니다.")]),t._v(" "),n("p",[t._v("엔진엑스 설정이 모여있는 /etc/nginx/conf.d/ 에 service-url.inc라는 파일을 생성합니다.")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("service-url.inc")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo vim /etc/nginx/conf.d/service-url.inc\n")])])]),n("p",[n("code",[t._v("코드입력")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("set $service_url http://127.0.0.1:8080; \n")])])]),n("p",[n("code",[t._v("nginx.conf")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo vim /etc/nginx/nginx.conf\n")])])]),n("p",[n("code",[t._v("service_url 추가")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(353),width:"90%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br"),n("br"),t._v(" "),n("code",[t._v("nginx 재기동")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("sudo service nginx restart\n")])])])]),t._v(" "),n("h3",{attrs:{id:"_5-배포-스크립트-작성"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-배포-스크립트-작성","aria-hidden":"true"}},[t._v("#")]),t._v(" 5. 배포 스크립트 작성")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("디렉토리 생성")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("mkdir ~/app/step3 && mkdir ~/app/step3/zip\n")])])]),n("p",[n("code",[t._v("appspec.yml 수정")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("version: 0.0\nos: linux\nfiles:\n - source:  /\n   destination: /home/ec2-user/app/step3/zip/\n   overwrite: yes\n")])])])]),t._v(" "),n("p",[t._v("무중단 배포를 진행할 스크립트들은 총 5개입니다.")]),t._v(" "),n("ul",[n("li",[t._v("stop.sh : 기존 엔진엑스에 연결되어 있진 않지만, 실행 중이던 스프링 부트 종료")]),t._v(" "),n("li",[t._v("start.sh : 배포할 신규 버전 스프링 부트 프로젝트를 stop.sh로 종료한 'profile'로 실행")]),t._v(" "),n("li",[t._v("health.sh : 'start.sh'로 실행시간 프로젝트가 정상적으로 실행됐는지 체크")]),t._v(" "),n("li",[t._v("switch.sh : 엔진엑스가 바라보는 스프링 부트를 최신 버전으로 변경")]),t._v(" "),n("li",[t._v("profile.sh : 앞선 4개 스크립트 파일에서 공용으로 사용할 'profile'과 포트 체크 로직")])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("appspec.yml 수정")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("hooks:\n AfterInstall:\n   - location: stop.sh #엔진엑스와 연결되어 있지 않은 스프링 부트를 종료합니다.\n     timeout: 60\n     runas: ec2-user\n ApplicationStart:\n   - location: start.sh # 엔진엑스와 연결되어 있지 않은 Port로 새 버전의 스프링 부트를 시작합니다.\n     timeout: 60\n     runas: ec2-user\n ValidateService:\n   - location: health.sh # 새 스프링 부트가 정상적으로 실행됐는지 확인합니다.\n     timeout: 60\n     runas: ec2-user\n")])])])]),t._v(" "),n("ul",[n("li",[t._v("Jar 파일이 복사된 이후부터 차례로 앞선 스크립트들이 실행된다고 보면 된다.")])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("profile.sh")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('#!/usr/bin/env bash\n\n# 쉬고 있는 profile 찾기: real1이 사용 중이라면 real2가 쉬고 있고, 반대면 real1이 쉬고있음\n\nfunction find_idle_profile(){\n RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/profile)\n\n if [ ${RESPONSE_CODE} -ge 400 ] # 400 보다 크면(즉, 40x/50x 에러 모두 포함)\n then\n     CUREENT_PROFILE=real2\n else\n     CUREENT_PROFILE=$(curl -s http://localhost/profile)\n fi\n\n if [ $(CUREENT_PROFILE) == real1 ]\n then\n     IDLE_PROFILE=real2\n else\n     IDLE_PROFILE=real1\n fi\n\n echo "${IDLE_PROFILE}"\n}\n\n# 쉬고 있는 profile의 port 찾기\nfunction find_idel_port() {\n   IDLE_PROFILE=$(find_idle_profile)\n\n   if [ ${IDLE_PROFILE} == real1 ]\n   then\n       echo "8081"\n   else\n       echo "8082"\n   fi\n}\n')])])])]),t._v(" "),n("h4",{attrs:{id:"코드-설명-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드-설명-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드 설명")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v('$(curl -s -o /dev/null -w "%{http_code}" http://localhost/profile)')]),t._v(" "),n("ul",[n("li",[t._v("현재 엔진엑스가 바라보고 있는 스프링 부트가 정상적으로 수행 중인지 확인")]),t._v(" "),n("li",[t._v("응답값을 HttpStatus로 받습니다.")]),t._v(" "),n("li",[t._v("정상이면 200, 오류가 발생한다면 400~503 사이로 발생하니 400 이상은 모두 예외로 보고 real2를 현재 profile로 사용")])])]),t._v(" "),n("li",[n("strong",[t._v("IDLE_PROFILE")]),t._v(" "),n("ul",[n("li",[t._v("엔진엑스와 연결되지 않은 profile")]),t._v(" "),n("li",[t._v("스프링 부트 프로젝트를 이 profile로 연결하기 위해 반환")])])]),t._v(" "),n("li",[n("strong",[t._v('echo "${IDLE_PROFILE}"')]),t._v(" "),n("ul",[n("li",[t._v("bash라는 스크립트는 "),n("strong",[t._v("값을 반환하는 기능이 없습니다.")])]),t._v(" "),n("li",[t._v("그래서 제일 마지막 줄에 echo로 결과를 출력 후, 클라이언트에서 그값을 잡아서 $(find_idle_profile) 사용합니다.")]),t._v(" "),n("li",[t._v("중간에 echo를 사용해선 안됩니다.")])])])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("stop.sh")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('#!/usr/bin/env bash\n\nABSPATH=$(readlink -f $0)\nABSDIR=$(dirname $ABSPATH)\nsource ${ABSDIR}/profile.sh\n\nIDLE_PORT=$(find_idle_port)\n\necho "> $IDLE_PORT 에서 구동 중인 애플리케이션 pid 확인"\nIDLE_PID=$(lsof -ti tcp:${IDLE_PORT})\n\nif [ -z ${IDLE_PID} ]\nthen\n echo "> 현재 구동 중인 애플리케이션이 없으므로 종료하지 않습니다."\nelse\n echo "> kill -15 $IDLE_PID"\n kill -15 ${IDLE_PID}\n sleep 5\nfi\n')])])])]),t._v(" "),n("h4",{attrs:{id:"코드설명-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드설명-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드설명")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v("ABSDIR=$(dirname $ABSPATH)")]),t._v(" "),n("ul",[n("li",[t._v("현재 stop.sh가 속해 있는 경로 찾기")])])]),t._v(" "),n("li",[n("strong",[t._v("source ${ABSDIR}/profile.sh")]),t._v(" "),n("ul",[n("li",[t._v("자바로 보면 일종의 import 구문")]),t._v(" "),n("li",[t._v("해당 코드로 인해 stop.sh에서도 profile.sh의 여러 function을 사용할 수 있게 됩니다.")])])])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("start.sh")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('#!/usr/bin/env bash\n\nABSPATH=$(readlink -f $0)\nABSDIR=$(dirname $ABSPATH)\nsource ${ABSDIR}/profile.sh\n\nREPOSITORY=/home/ec2-user/app/step3\nPROJECT_NAME=springboot-webservice\n\necho "> Build 파일 복사"\necho "> cp $REPOSITORY/zip/*.jar $REPOSITORY/"\n\ncp $REPOSITORY/zip/*.jar $REPOSITORY/\n\necho "> 새 애플리케이션 배포"\nJAR_NAME=$(ls -tr $REPOSITORY/*.jar | tail -n 1)\n\necho "> JAR Name : $JAR_NAME"\n\necho "> $JAR_NAME 에 실행권한 추가"\n\nchmod +x $JAR_NAME\n\necho "> $JAR_NAME 실행"\n\nIDLE_PROFILE=$(find_idle_profile)\n\necho "> $JAR_NAME 를 profile=$IDLE_PROFILE 로 실행합니다."\n\nnohup java -jar \\\n  -Dspring.config.location=classpath:/application.properties,classpath:/application-$IDLE_PROFILE.properties,/home/ec2-user/app/application-oauth.properties,/home/ec2-user/app/application-real-db.properties \\\n  -Dspring.profiles.active=$IDLE_PROFILE \\\n  $JAR_NAME > $REPOSITORY/nohup.out 2>&1 &\n')])])])]),t._v(" "),n("h4",{attrs:{id:"코드설명-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드설명-3","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드설명")]),t._v(" "),n("ol",[n("li",[t._v("prfile.sh를 통해 IDLE_PROFILE를 가져온다.\n"),n("ul",[n("li",[t._v("-Dspring.profiles.active=$IDLE_PROFILE 설정")]),t._v(" "),n("li",[t._v("classpath:/application-$IDLE_PROFILE.properties 설정")])])])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("health.sh")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('#!/usr/bin/env bash\n\nABSPATH=$(readlink -f $0)\nABSDIR=$(dirname $ABSPATH)\nsource ${ABSDIR}/profile.sh\nSOURCE ${ABSDIR}/switch.sh\n\nIDLE_PORT=$(find_idle_port)\n\necho "> Health Check Start!"\necho "> IDLE_PORT: $IDLE_PORT"\necho "> curl -s http://localhost:$IDLE_PORT/profile"\nsleep 10\n\nfor RETRY_COUNT in {1..10}\ndo\n RESPONSE=$(curl -s http://localhost:${IDLE_PORT}/profile)\n UP_COUNT=$(echo ${RESPONSE} | grep \'real\' | wc -l)\n\n if [ ${UP_COUNT} -ge 1 ]\n then #$up_count >= 1 ("real" 문자열이 있는지 검증)\n   echo "> Health check 성공"\n   switch_proxy\n   break\n else\n   echo "> Health check의 응답을 알 수 없거나 혹은 실행 상태가 아닙니다."\n   echo "> Health check: ${RESPONSE}"\n fi\n\n if [ ${RETRY_COUNT} -eq 10 ]\n then\n   echo "> Health check 실패. "\n   echo "> 엔진엑스에 연결하지 않고 배포를 종료합니다."\n   exit 1\n fi\n\n echo "> Health check 연결 실패. 재시도..."\n sleep 10\ndone\n')])])])]),t._v(" "),n("h4",{attrs:{id:"코드설명-4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드설명-4","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드설명")]),t._v(" "),n("ol",[n("li",[t._v("엔진엑스와 연결되지 않은 포트로 스프링 부트가 잘 수행되었는지 체크")]),t._v(" "),n("li",[t._v("정상 확인 후 엔진엑스 프록시 설정 변경(switch_proxy)")]),t._v(" "),n("li",[t._v("엔진엑스 프록시 설정 변경은 switch.sh에서 수행")])]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("switch.sh")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('#!/usr/bin/env bash\n\nABSPATH=$(readlink -f $0)\nABSDIR=$(dirname $ABSPATH)\nsource ${ABSDIR}/profile.sh\n\nfunction switch_proxy() {\n IDLE_PORT=$(find_idle_port)\n\n echo "> 전환할 Port: $IDLE_PORT"\n echo "> Port 전환"\n echo "set \\$service_url http://127.0.0.1:${IDLE_PORT};" | sudo tee /etc/nginx/conf.d/service-url.inc\n\n echo "> 엔진엑스 Reload"\n sudo service nginx reload\n}\n')])])])]),t._v(" "),n("h4",{attrs:{id:"코드설명-5"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#코드설명-5","aria-hidden":"true"}},[t._v("#")]),t._v(" 코드설명")]),t._v(" "),n("ol",[n("li",[n("strong",[t._v('echo "set $service_url http://127.0.0.1:${IDLE_PORT};"')]),t._v(" "),n("ul",[n("li",[t._v("하나의 문장을 만들어 파이프라인(|)으로 넘겨주기 위해 echo를 사용")]),t._v(" "),n("li",[t._v("엔진엑스가 변경할 프록시 주소를 생성")]),t._v(" "),n("li",[t._v('쌍따옴표 (")를 사용해야 합니다.')]),t._v(" "),n("li",[t._v("사용하지 않으면 $service_url을 그대로 인식하지 못하고 변수를 찾게 됩니다.")])])]),t._v(" "),n("li",[n("strong",[t._v("sudo tee /etc/nginx/conf.d/service-url.inc")]),t._v(" "),n("ul",[n("li",[t._v("앞에서 넘겨준 문장을 service-url.inc에 덮어 씁니다.")])])]),t._v(" "),n("li",[n("strong",[t._v("sudo service nginx reload")]),t._v(" "),n("ul",[n("li",[t._v("엔진엑스 설정을 "),n("strong",[t._v("다시 불러")]),t._v("온다.")]),t._v(" "),n("li",[t._v("restart는 잠시 끊기는 현상이 있지만, reload는 끊김 없이 다시 블러온다.")])])])]),t._v(" "),n("h2",{attrs:{id:"무중단-배포-테스트"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#무중단-배포-테스트","aria-hidden":"true"}},[t._v("#")]),t._v(" 무중단 배포 테스트")]),t._v(" "),n("blockquote",[n("p",[n("code",[t._v("build.gradle 수정")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("version '1.0.1-SNAPSHOT-' + new Date().format(\"yyyyMMddHHmmss\")\n")])])]),n("p",[n("code",[t._v("CodeDeply 로그 확인")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("tail -f /opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log\n")])])]),n("p",[n("img",{attrs:{src:a(354),width:"100%",height:"100%",title:"Nginx",alt:"Nginx"}}),n("br"),n("br"),t._v(" "),n("code",[t._v("스프링 부트 로그")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("vim ~/app/step3/nohup.out\n")])])]),n("p",[n("code",[t._v("자바 애플리케이션 실행 여부")])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("ps -ef | grep java\n")])])]),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("ec2-user  1626     1  1 20:22 ?        00:00:17 java -jar -Dspring.config.location=classpath:/application.properties,classpath:/application-real1.properties,/home/ec2-user/app/application-oauth.properties,/home/ec2-user/app/application-real-db.properties -Dspring.profiles.active=real1 /home/ec2-user/app/step3/springboot-webservice-1.0.1-SNAPSHOT-20200330112116.jar\nec2-user  1809     1  5 20:35 ?        00:00:15 java -jar -Dspring.config.location=classpath:/application.properties,classpath:/application-real2.properties,/home/ec2-user/app/application-oauth.properties,/home/ec2-user/app/application-real-db.properties -Dspring.profiles.active=real2 /home/ec2-user/app/step3/springboot-webservice-1.0.1-SNAPSHOT-20200330113405.jar\n")])])])])])}],e=a(0),r=Object(e.a)({},(function(){var t=this.$createElement;this._self._c;return this._m(0)}),n,!1,null,null,null);s.default=r.exports}}]);